<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lite-CAD Web (DWG Compatible)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/makerjs@0.18.0/dist/browser.maker.js"></script>
    
    <style>
        body { margin: 0; background: #1a1a1a; color: #eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; }
        
        /* Sidebar & Toolbars */
        .toolbar { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; gap: 8px; background: #333; padding: 12px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); align-items: center; }
        .properties-panel { width: 240px; background: #252525; border-left: 1px solid #444; padding: 20px; display: none; flex-direction: column; z-index: 20; height: 100vh; position: absolute; right: 0; }
        
        /* Canvas Styling */
        .canvas-container { cursor: crosshair !important; flex-grow: 1; }
        
        /* UI Elements */
        button, select, input { background: #444; color: white; border: 1px solid #555; padding: 6px 12px; cursor: pointer; font-size: 13px; }
        button:hover { background: #555; }
        .btn-primary { background: #0078d4; border: none; font-weight: bold; }
        .label { font-size: 10px; color: #888; margin-bottom: 4px; display: block; text-transform: uppercase; }
        .input-group { margin-bottom: 15px; }
        
        /* Status Bar */
        .status-bar { position: absolute; bottom: 0; width: 100%; background: #333; padding: 5px 20px; font-size: 12px; color: #aaa; border-top: 1px solid #444; z-index: 5; }
    </style>
</head>
<body>

    <div class="toolbar">
        <select id="layerSelect">
            <option value="0" data-color="#ffffff">Layer 0 (White)</option>
            <option value="WALLS" data-color="#00ff00">Walls (Green)</option>
            <option value="CENTER" data-color="#ff0000">Center (Red)</option>
            <option value="HIDDEN" data-color="#ffff00">Hidden (Yellow)</option>
        </select>
        <button onclick="setMode('line')">Line</button>
        <button onclick="setMode('rect')">Rect</button>
        <button class="btn-primary" onclick="exportDXF()">Export DXF/DWG</button>
        <button onclick="canvas.clear(); drawGrid();" style="color: #ff5f57;">Clear</button>
    </div>

    <canvas id="c"></canvas>

    <div id="propertiesPanel" class="properties-panel">
        <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #0078d4;">PROPERTIES</h3>
        <div class="input-group">
            <span class="label">Layer</span>
            <select id="propLayer" style="width: 100%;"></select>
        </div>
        <div class="input-group">
            <span class="label">Coordinates</span>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <input type="number" id="propX1" step="10"> <input type="number" id="propY1" step="10">
                <input type="number" id="propX2" step="10"> <input type="number" id="propY2" step="10">
            </div>
        </div>
        <button onclick="deleteObject()" style="background: #a33; border:none; margin-top: auto;">Delete Selected</button>
    </div>

    <div class="status-bar" id="coords">X: 0, Y: 0 | Snap: 20px | Alt+Click to Pan</div>

    <script>
        const canvas = new fabric.Canvas('c', { backgroundColor: '#1a1a1a', selection: true });
        let grid = 20;
        let mode = 'line';
        let isDrawing = false;
        let currentObj;

        // Initialize Canvas Size
        function resize() {
            canvas.setWidth(window.innerWidth);
            canvas.setHeight(window.innerHeight);
            drawGrid();
        }
        window.addEventListener('resize', resize);
        resize();

        function drawGrid() {
            canvas.getObjects('line').filter(l => l.isGrid).forEach(l => canvas.remove(l));
            for (let i = 0; i < (canvas.width / grid); i++) {
                canvas.add(new fabric.Line([i * grid, 0, i * grid, canvas.height], { stroke: '#2a2a2a', selectable: false, evented: false, isGrid: true }));
                canvas.add(new fabric.Line([0, i * grid, canvas.width, i * grid], { stroke: '#2a2a2a', selectable: false, evented: false, isGrid: true }));
            }
            canvas.sendToBack(canvas.getObjects().find(o => o.isGrid));
        }

        function setMode(m) { mode = m; canvas.discardActiveObject().renderAll(); }

        // MOUSE EVENTS: Drawing & Snapping
        canvas.on('mouse:down', function(o) {
            if (o.e.altKey || o.e.button === 1) { this.isDragging = true; return; }
            if (canvas.getActiveObject()) return;

            isDrawing = true;
            let pointer = canvas.getPointer(o.e);
            let snapX = Math.round(pointer.x / grid) * grid;
            let snapY = Math.round(pointer.y / grid) * grid;

            const layerEl = document.getElementById('layerSelect');
            const layerColor = layerEl.options[layerEl.selectedIndex].getAttribute('data-color');

            if (mode === 'line') {
                currentObj = new fabric.Line([snapX, snapY, snapX, snapY], { stroke: layerColor, strokeWidth: 2, selectable: true });
                currentObj.layer = layerEl.value;
            }
            canvas.add(currentObj);
        });

        canvas.on('mouse:move', function(o) {
            let pointer = canvas.getPointer(o.e);
            let snapX = Math.round(pointer.x / grid) * grid;
            let snapY = Math.round(pointer.y / grid) * grid;
            document.getElementById('coords').innerText = `X: ${snapX}, Y: ${Math.round(canvas.height - snapY)} | Snap: 20px | Alt+Click to Pan`;

            if (this.isDragging) {
                let vpt = this.viewportTransform;
                vpt[4] += o.e.movementX;
                vpt[5] += o.e.movementY;
                this.requestRenderAll();
                return;
            }

            if (!isDrawing) return;
            currentObj.set({ x2: snapX, y2: snapY });
            canvas.renderAll();
        });

        canvas.on('mouse:up', () => { isDrawing = false; this.isDragging = false; });

        // ZOOM
        canvas.on('mouse:wheel', function(opt) {
            let delta = opt.e.deltaY;
            let zoom = canvas.getZoom() * (0.999 ** delta);
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
        });

        // PROPERTIES LOGIC
        canvas.on('selection:created', (e) => updatePanel(e.selected[0]));
        canvas.on('selection:updated', (e) => updatePanel(e.selected[0]));
        canvas.on('selection:cleared', () => document.getElementById('propertiesPanel').style.display = 'none');

        function updatePanel(obj) {
            const panel = document.getElementById('propertiesPanel');
            panel.style.display = 'flex';
            document.getElementById('propX1').value = obj.x1;
            document.getElementById('propY1').value = obj.y1;
            document.getElementById('propX2').value = obj.x2;
            document.getElementById('propY2').value = obj.y2;
            
            const pLayer = document.getElementById('propLayer');
            pLayer.innerHTML = document.getElementById('layerSelect').innerHTML;
            pLayer.value = obj.layer || "0";
            
            pLayer.onchange = (e) => {
                obj.layer = e.target.value;
                obj.set({ stroke: e.target.options[e.target.selectedIndex].getAttribute('data-color') });
                canvas.renderAll();
            };
        }

        function deleteObject() { canvas.remove(canvas.getActiveObject()); }

        // EXPORT TO DXF
        function exportDXF() {
            const makerjs = window.require('makerjs');
            const model = { paths: {} };
            canvas.getObjects().forEach((obj, i) => {
                if (obj.type === 'line' && !obj.isGrid) {
                    const line = new makerjs.paths.Line([obj.x1, -obj.y1], [obj.x2, -obj.y2]);
                    line.layer = obj.layer || "0";
                    model.paths['L' + i] = line;
                }
            });
            const dxf = makerjs.exporter.toDXF(model);
            const blob = new Blob([dxf], {type: 'application/dxf'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'web_cad_drawing.dxf';
            link.click();
        }
    </script>
</body>
</html>
